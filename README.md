# Species tree estimation

This project aims to build consensus species tree using DNA alignments of SARS-COV2 sequences. There are 5,248 sequences under study, and we use 40,028 sequences as validation dataset to test the results.

Identical sequences are removed in alignments of each gene, then bootstrap gene trees are built. With 1100 distance matrices generated from estimated gene trees, a consensus species tree was built by the majority rule method using SumTrees v. 4.0.0. More specifically, in each gene tree, distance between any two tips was calculated by finding the shortest path from one node to the other; i.e., finding the most recent common ancestor of two given nodes. All identical sequences were considered as a polytomy to eliminate the magnification of distance. For each bootstrap, based on the average distance matrix from 11 genes, a bootstrap species tree was built using the neighbor joining method by the neighbor program in PHYLIP v. 3.697. Finally, the consensus species tree was summarized with 100 sets of bootstrap species trees by SumTrees.

In order to validate our method with 40,000+ taxa dataset, neighbor joining species trees were reconstructed with NJ function in ape in R to improve the efficiency. Then, the consensus species tree was summarized with the extended majority rule consensus method in RAxML with command line raxmlHPC -mGTRCAT -J MRE -z inputfile -n outputfile -p seed. For such a large dataset, ORF10 was removed to eliminate the influence of a missing ORF10 gene for all bats and MERS samples. Such missing data would influence the average distance when other distances are not at same magnitude with ORF10. This problem is not severe for a small dataset because of small non-identical sequences in each gene tree.

A faster distance matrix computing algorithm was developed for 40,000+ taxa compared with NJst function in the phybase library in R, which could deal with smaller trees with 100+ taxa. First, the order of appearance for all taxa in a tree string was recorded. Next, we sequentially numbered all parentheses and recorded indexes of parentheses immediately before and after each taxon. From a short string consisting only of parentheses, the distance between the two taxa was 1 plus the number of unpaired parentheses between two of them. For example, for a small tree “((A, B), ((C, (D, E)), F));” the short string for the middle segment from B to F is “)((())”, after continually removing two paired parentheses “(())”, the short string only had “)(” left, indicating the distance from B to F is 3. Here, the short string in the middle segment of the two taxa are extracted according to the indexes recorded, all paired parentheses are regarded as siblings. By removing them we could find the shortest path.

# R code

The R code to build consensus species tree is in  **Species_Tree_Construct_Process.html** in folder "JY". Alignments and all identical sequences are saved in "JY/0alignment". With consensus species tree, clades detection algorithm are in folder "JY/8clades/Find_Human_Clades.R". Gene tree plots can be drawn by Figtree or by the R code in "JY/9plottrees/plot_fig1_2.R".
